# Database Schema Reference

> **⚠️ AUTO-GENERATED FILE**  
> This file is automatically generated. Do not edit manually.  
> To update: run `npm run schema:update`

Generated on: 2025-01-07

This file contains the exact database schema to prevent column name mismatches when writing SQL code.

## How to Keep This Updated

1. **After schema changes**: Run `npm run schema:update` to refresh this file
2. **Before writing SQL**: Check this file for exact column names and relationships
3. **During development**: Update this file if you add new migrations or modify tables

## Update Process

```bash
# Update the schema reference file
npm run schema:update

# The file will be automatically regenerated with current database schema
```

## Tables

### tournaments
| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| name | text | NO | | Tournament name |
| description | text | YES | | Tournament description |
| status | text | NO | 'draft' | draft, active, completed |
| max_contestants | integer | NO | 8 | Maximum number of contestants |
| created_by | uuid | NO | | References users.id |
| created_at | timestamp | NO | now() | |
| updated_at | timestamp | NO | now() | |
| image_url | text | YES | | Tournament image |

### contestants
| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| tournament_id | uuid | NO | | References tournaments.id |
| name | text | NO | | Contestant name |
| description | text | YES | | Contestant description |
| image_url | text | YES | | Contestant image |
| seed | integer | YES | | Tournament seeding |
| created_at | timestamp | NO | now() | |

### rounds
| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| tournament_id | uuid | NO | | References tournaments.id |
| name | text | NO | | Round name (e.g., "Final", "Semifinal") |
| round_number | integer | NO | | Round order (1 = final, 2 = semifinal, etc.) |
| status | text | NO | 'upcoming' | upcoming, active, completed |
| created_at | timestamp | NO | now() | |

### matchups
| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| round_id | uuid | NO | | References rounds.id |
| match_number | integer | NO | | Match number within round |
| contestant1_id | uuid | YES | | References contestants.id |
| contestant2_id | uuid | YES | | References contestants.id |
| winner_id | uuid | YES | | References contestants.id |
| status | text | NO | 'upcoming' | upcoming, active, completed |
| contestant1_votes | integer | NO | 0 | Vote count for contestant1 |
| contestant2_votes | integer | NO | 0 | Vote count for contestant2 |
| total_votes | integer | NO | 0 | Total votes for this matchup |
| is_tie | boolean | NO | false | Whether matchup ended in tie |
| created_at | timestamp | NO | now() | |

### votes
| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| matchup_id | uuid | NO | | References matchups.id |
| user_id | uuid | NO | | References users.id |
| selected_contestant_id | uuid | NO | | References contestants.id |
| created_at | timestamp | NO | now() | |

### users
| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| email | text | NO | | User email |
| is_admin | boolean | NO | false | Admin privileges |
| created_at | timestamp | NO | now() | |
| updated_at | timestamp | NO | now() | |
| avatar_url | text | YES | | User avatar image |

## Foreign Key Relationships

| Table | Column | References Table | References Column |
|-------|--------|------------------|-------------------|
| tournaments | created_by | users | id |
| contestants | tournament_id | tournaments | id |
| rounds | tournament_id | tournaments | id |
| matchups | round_id | rounds | id |
| matchups | contestant1_id | contestants | id |
| matchups | contestant2_id | contestants | id |
| matchups | winner_id | contestants | id |
| votes | matchup_id | matchups | id |
| votes | user_id | users | id |
| votes | selected_contestant_id | contestants | id |

## Tournament-Related Functions

| Function Name | Type | Return Type | Purpose |
|---------------|------|-------------|---------|
| generate_bracket | FUNCTION | void | Creates bracket structure |
| start_tournament | FUNCTION | void | Starts tournament and generates bracket |
| reset_tournament_bracket | FUNCTION | void | Resets tournament to draft state |
| can_start_tournament | FUNCTION | boolean | Checks if tournament can be started |
| get_bracket_data | FUNCTION | record | Gets bracket data for visualization |

## Common Mistakes to Avoid

1. **Column Names**: Always use exact column names from the tables above
2. **Foreign Keys**: Use the relationships table to verify correct column references
3. **Data Types**: Match the exact data types when creating functions
4. **Null Constraints**: Check nullable column before assuming values exist
5. **Status Values**: Use exact status strings ('draft', 'active', 'completed', 'upcoming')

## Quick Reference - Most Common Columns

### tournaments table:
- `id` (uuid, primary key)
- `name` (text, not null)
- `status` (text, not null, default 'draft')
- `max_contestants` (integer, not null, default 8)
- `created_by` (uuid, not null, references users.id)

### contestants table:
- `id` (uuid, primary key)
- `tournament_id` (uuid, not null, references tournaments.id)
- `name` (text, not null)
- `image_url` (text, nullable)
- `seed` (integer, nullable)

### rounds table:
- `id` (uuid, primary key)
- `tournament_id` (uuid, not null, references tournaments.id)
- `name` (text, not null)
- `round_number` (integer, not null)
- `status` (text, not null, default 'upcoming')

### matchups table:
- `id` (uuid, primary key)
- `round_id` (uuid, not null, references rounds.id)
- `match_number` (integer, not null)
- `contestant1_id` (uuid, nullable, references contestants.id)
- `contestant2_id` (uuid, nullable, references contestants.id)
- `winner_id` (uuid, nullable, references contestants.id)
- `status` (text, not null, default 'upcoming')
- `contestant1_votes` (integer, not null, default 0)
- `contestant2_votes` (integer, not null, default 0)
- `total_votes` (integer, not null, default 0)
- `is_tie` (boolean, not null, default false)

### votes table:
- `id` (uuid, primary key)
- `matchup_id` (uuid, not null, references matchups.id)
- `user_id` (uuid, not null, references users.id)
- `selected_contestant_id` (uuid, not null, references contestants.id)

### users table:
- `id` (uuid, primary key)
- `email` (text, not null)
- `is_admin` (boolean, not null, default false)

## Key Relationships Summary

1. **tournaments** → **contestants** (one-to-many via tournament_id)
2. **tournaments** → **rounds** (one-to-many via tournament_id)
3. **rounds** → **matchups** (one-to-many via round_id)
4. **contestants** → **matchups** (contestants can appear in multiple matchups)
5. **matchups** → **votes** (one-to-many via matchup_id)
6. **users** → **votes** (one-to-many via user_id)
7. **users** → **tournaments** (one-to-many via created_by)

## SQL Best Practices

1. Always use proper JOIN syntax with explicit ON clauses
2. Use table aliases for better readability
3. Check for NULL values before making comparisons
4. Use proper data types (uuid for IDs, text for strings, etc.)
5. Always include proper error handling in functions
6. Use transactions for multi-table operations
7. Follow naming conventions (snake_case for columns, camelCase for functions)

## Common Query Patterns

```sql
-- Get tournament with contestants
SELECT t.*, c.name as contestant_name
FROM tournaments t
LEFT JOIN contestants c ON t.id = c.tournament_id
WHERE t.id = $1;

-- Get bracket data
SELECT r.*, m.*, 
       c1.name as contestant1_name,
       c2.name as contestant2_name
FROM rounds r
LEFT JOIN matchups m ON r.id = m.round_id
LEFT JOIN contestants c1 ON m.contestant1_id = c1.id
LEFT JOIN contestants c2 ON m.contestant2_id = c2.id
WHERE r.tournament_id = $1
ORDER BY r.round_number DESC, m.match_number;

-- Get user votes for tournament
SELECT v.*, m.round_id, c.name as selected_contestant_name
FROM votes v
JOIN matchups m ON v.matchup_id = m.id
JOIN contestants c ON v.selected_contestant_id = c.id
JOIN rounds r ON m.round_id = r.id
WHERE v.user_id = $1 AND r.tournament_id = $2;
```